{% extends 'core/base.html' %}
{% load embed_video_tags %}
{% load library_extras %}
{% load comments_extras %}

{% block title %}{{ game.title }}{% endblock %}

{% block content %}
    {% get_localized_data game user as local_game %}

<div style="margin-top: 20px;">
    <a href="{% url 'library:game_list' %}" style="color: #888; text-decoration: none;">&larr; Back to Library</a>

    <div style="display: flex; gap: 40px; margin-top: 20px; flex-wrap: wrap;">

        <div style="flex: 1; min-width: 300px;">

            <div class="gallery-hero">
                {% if local_game.box_art %}
                    <img id="hero-img" src="{{ local_game.box_art.url }}" alt="Main Display">
                {% else %}
                    <div style="color: #666;">NO ART</div>
                {% endif %}
            </div>

            <div class="thumb-strip">
                {% if local_game.box_art %}
                <div class="thumb-btn active" onclick="swapImage(this, '{{ local_game.box_art.url }}')"><img src="{{ local_game.box_art.url }}"></div>
                {% endif %}

                {% if local_game.back_art %}
                <div class="thumb-btn" onclick="swapImage(this, '{{ local_game.back_art.url }}')"><img src="{{ local_game.back_art.url }}"></div>
                {% endif %}

                {% if local_game.spine_art %}
                <div class="thumb-btn" onclick="swapImage(this, '{{ local_game.spine_art.url }}')"><img src="{{ local_game.spine_art.url }}"></div>
                {% endif %}

                {% if game.media_art %}
                <div class="thumb-btn" onclick="swapImage(this, '{{ game.media_art.url }}')"><img src="{{ game.media_art.url }}"></div>
                {% endif %}

                {% if game.screenshot %}
                <div class="thumb-btn" onclick="swapImage(this, '{{ game.screenshot.url }}')"><img src="{{ game.screenshot.url }}"></div>
                {% endif %}

                {% for extra_img in game.gallery_images.all %}
                <div class="thumb-btn" onclick="swapImage(this, '{{ extra_img.image.url }}')" title="{{ extra_img.caption }}">
                    <img src="{{ extra_img.image.url }}">
                </div>
                {% endfor %}
            </div>

            <script>
                function swapImage(element, url) {
                    const hero = document.getElementById('hero-img');
                    if (hero) hero.src = url;
                    const thumbs = document.querySelectorAll('.thumb-btn');
                    thumbs.forEach(t => t.classList.remove('active'));
                    element.classList.add('active');
                }
            </script>

            <table style="width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.9rem;">
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Developer</td>
                    <td style="padding: 10px; text-align: right;">
                        {% for dev in game.developers.all %}
                            {{ dev.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %} - {% endfor %}
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Publisher</td>
                    <td style="padding: 10px; text-align: right;">
                        {% for pub in game.publishers.all %}
                            {{ pub.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %} - {% endfor %}
                    </td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Released</td>
                    <td style="padding: 10px; text-align: right;">{{ local_game.release_date|date:"F j, Y"|default:"-" }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Platform</td>
                    <td style="padding: 10px; text-align: right;">{{ game.platform.name }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Region</td>
                    <td style="padding: 10px; text-align: right;">
                        {% for reg in game.regions.all %}
                            {{ reg.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %} - {% endfor %}
                    </td>
                </tr>

                {% if game.owned_regions.exists %}
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Owned Ver.</td>
                    <td style="padding: 10px; text-align: right; color: var(--secondary);">
                        {% for reg in game.owned_regions.all %}
                            {{ reg.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                </tr>
                {% endif %}

                {% if game.condition_notes %}
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Notes</td>
                    <td style="padding: 10px; text-align: right; color: var(--accent); font-style: italic;">
                        {{ game.condition_notes }}
                    </td>
                </tr>
                {% endif %}

                <tr style="border-bottom: 1px solid #333;">
                    <td colspan="2" style="padding: 0;">
                        {% if game.game_format == 'DIGITAL' %}
                            <div style="padding: 15px; text-align: center; background: #111;">
                                <span style="color: var(--secondary); font-family: 'Press Start 2P'; font-size: 0.7rem;">DIGITAL COPY</span>
                            </div>
                        {% else %}
                            {% if game.video_condition %}
                                <div style="position: relative; width: 100%; aspect-ratio: 9/16; background: #000;">
                                    <div class="video-wrapper" style="height: 100%; padding-bottom: 0;">
                                        {% video game.video_condition '100% x 100%' %}
                                    </div>
                                    <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; text-align: center; padding: 5px; font-size: 0.7rem;">
                                        CONDITION REPORT
                                    </div>
                                </div>
                            {% else %}
                                <div style="padding: 15px;">
                                    <div style="display: flex; gap: 5px; justify-content: center; font-size: 0.8rem;">
                                        <span style="color: {% if game.own_game %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">GAME</span>
                                        <span style="color: {% if game.own_box %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">BOX</span>
                                        <span style="color: {% if game.own_manual %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">MAN</span>
                                    </div>
                                    {% if game.components.exists %}
                                        <div style="margin-top: 10px; text-align: center; font-size: 0.7rem; color: #888;">
                                            {% for comp in game.components.all %}
                                                <div>{% if comp.is_owned %}‚úÖ{% else %}‚ùå{% endif %} {{ comp.name }}</div>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>

        <div style="flex: 2; min-width: 300px;">
            <h1 style="margin-top: 0; font-size: 2rem;">{{ local_game.title }}</h1>

            <div style="margin-bottom: 20px;">
                {% for genre in game.genres.all %}
                    <span style="background: var(--primary); color: #000; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; margin-right: 5px;">{{ genre.name }}</span>
                {% endfor %}
            </div>

            <div style="font-size: 1rem; color: #888; margin-bottom: 30px; font-style: italic;">
                {{ game.description|linebreaks }}
            </div>

            <hr style="border: 0; border-top: 1px dashed #333; margin: 30px 0;">

            <h2 class="retro-font" style="font-size: 1.2rem; color: var(--secondary);">480p Content</h2>

            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 40px;">
                <div style="flex: 1; min-width: 300px;">
                    <h3 class="retro-font" style="font-size: 0.8rem; margin-bottom: 10px;">480p Game Review Video</h3>
                    {% if game.video_review %}
                        <div class="video-wrapper">{% video game.video_review '100% x 100%' %}</div>
                    {% else %}
                        <div style="width: 100%; padding-bottom: 56.25%; background: #000; border: 1px solid #333; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="font-size: 2rem; opacity: 0.3;">üì∫</div>
                                <div style="color: #444; font-size: 0.8rem; margin-top: 10px; font-family: monospace;">NOT REVIEWED YET</div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div style="flex: 1; min-width: 300px;">
                    <h3 class="retro-font" style="font-size: 0.8rem; margin-bottom: 10px;">480p Full Game Video</h3>
                    {% if game.video_playthrough %}
                        <div class="video-wrapper">{% video game.video_playthrough '100% x 100%' %}</div>
                    {% else %}
                        <div style="width: 100%; padding-bottom: 56.25%; background: #000; border: 1px solid #333; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="font-size: 2rem; opacity: 0.3;">üéÆ</div>
                                <div style="color: #444; font-size: 0.8rem; margin-top: 10px; font-family: monospace;">NOT PLAYED YET</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <h2 class="retro-font" style="font-size: 1.2rem; color: var(--secondary);">480p Game Review</h2>
            {% if game.written_review %}
                <div style="font-size: 1.1rem; line-height: 1.8; color: #fff;">
                    {{ game.written_review|linebreaks }}
                </div>
            {% else %}
                <div style="border: 2px dashed #333; padding: 20px; background: rgba(0,0,0,0.3); text-align: center;">
                    <p style="color: #666; font-family: monospace; margin: 0;">
                        [ DATA MISSING ]<br>This title has not been reviewed yet.
                    </p>
                </div>
            {% endif %}

            {% if game.extra_videos.exists %}
                <div style="margin-top: 50px; border-top: 4px solid var(--primary); padding-top: 20px;">
                    <h2 class="retro-font" style="font-size: 1.2rem; color: var(--primary);">
                        480p Member Content
                    </h2>
                    <div class="grid" style="gap: 20px;">
                        {% for extra in game.extra_videos.all %}
                            {% if not extra.is_patron_only or user.profile.is_member %}
                                <div style="background: #000; border: 1px solid #333; padding: 10px;">
                                    <h4 style="margin: 0 0 10px 0; color: #fff; font-size: 0.9rem;">
                                        {% if extra.is_patron_only %}
                                            <span style="color: var(--primary);">[LOCKED]</span>
                                        {% endif %}
                                        {{ extra.title }}
                                    </h4>
                                    <div class="video-wrapper">
                                        {% video extra.url '100% x 100%' %}
                                    </div>
                                </div>
                            {% else %}
                                <div style="background: #111; border: 1px dashed #444; padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                    <div style="font-size: 2rem;">üîí</div>
                                    <div style="color: #666; margin-top: 10px;">{{ extra.title }}</div>
                                    <div style="color: var(--primary); font-size: 0.7rem; margin-top: 5px;">MEMBERS ONLY</div>
                                    <a href="{% url 'membership:select' %}" style="margin-top: 10px; color: #fff; text-decoration: underline; font-size: 0.8rem;">Unlock This</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            {% if game.series %}
            <div style="margin-top: 60px;">
                <h2 class="retro-font" style="font-size: 1.2rem; color: var(--secondary);">Series Collection</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                    {% for sibling in game.series.games.all %}
                        {% if sibling.id != game.id %}
                        <div class="card {% if not sibling.own_game %}ghost{% endif %}">
                            <a href="{% url 'library:game_detail' sibling.slug %}">
                                {% if sibling.box_art %}
                                    <img src="{{ sibling.box_art.url }}" alt="{{ sibling.title }}">
                                {% else %}
                                    <div style="height: 180px; background: #000; display: flex; align-items: center; justify-content: center; color: #555;">NO ART</div>
                                {% endif %}
                            </a>
                            <div class="card-title" style="font-size: 0.8rem;">{{ sibling.title }}</div>
                            <div class="card-meta">
                                <span>{{ sibling.platform.name }}</span>
                                {% if not sibling.own_game %}<span style="color: #666; float: right;">[GHOST]</span>{% endif %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if game.other_versions.exists %}
            <div style="margin-top: 40px;">
                <h2 class="retro-font" style="font-size: 1.2rem; color: #fff;">Other Releases</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
                    {% for ver in game.other_versions.all %}
                    <div class="card {% if not ver.own_game %}ghost{% endif %}">
                        <a href="{% url 'library:game_detail' ver.slug %}">
                            {% if ver.box_art %}
                                <img src="{{ ver.box_art.url }}" alt="{{ ver.title }}">
                            {% else %}
                                <div style="height: 180px; background: #000; display: flex; align-items: center; justify-content: center; color: #555;">NO ART</div>
                            {% endif %}
                        </a>
                        <div class="card-title" style="font-size: 0.8rem;">
                            <span style="color: var(--secondary);">{{ ver.platform.name }}</span><br>
                            {{ ver.title }}
                        </div>
                        <div class="card-meta">{% if not ver.own_game %}<span style="color: #666;">[GHOST]</span>{% endif %}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </div>
    </div>
</div>
{% render_comments game %}
{% endblock %}