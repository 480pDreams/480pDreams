{% extends 'core/base.html' %}
{% load embed_video_tags %}

{% block title %}{{ game.title }}{% endblock %}

{% block content %}
<div style="margin-top: 20px;">
    <a href="{% url 'library:game_list' %}" style="color: #888; text-decoration: none;">&larr; Back to Library</a>

    <div style="display: flex; gap: 40px; margin-top: 20px; flex-wrap: wrap;">

        <div style="flex: 1; min-width: 300px;">

            <div style="border: 2px solid #333; background: #000;">
                <div style="position: relative; aspect-ratio: 4/3; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <img id="carousel-img" src="" alt="{{ game.title }}" style="width: 100%; height: 100%; object-fit: contain; display: none;">
                    <div id="no-art-placeholder" style="color: #666; display: none;">NO ART</div>
                </div>

                <div class="carousel-controls">
                    <button class="carousel-btn" onclick="prevImage()">&lt;</button>
                    <span id="carousel-label" class="carousel-label">LOADING...</span>
                    <button class="carousel-btn" onclick="nextImage()">&gt;</button>
                </div>
            </div>

            <script>
                const gallery = [];
                // Build playlist from available images
                {% if game.box_art %} gallery.push({ src: "{{ game.box_art.url }}", label: "Front Cover" }); {% endif %}
                {% if game.back_art %} gallery.push({ src: "{{ game.back_art.url }}", label: "Back Cover" }); {% endif %}
                {% if game.media_art %} gallery.push({ src: "{{ game.media_art.url }}", label: "Media / Disc" }); {% endif %}
                {% if game.spine_art %} gallery.push({ src: "{{ game.spine_art.url }}", label: "Spine" }); {% endif %}
                {% if game.screenshot %} gallery.push({ src: "{{ game.screenshot.url }}", label: "Screenshot" }); {% endif %}

                let currentIndex = 0;
                const imgElement = document.getElementById('carousel-img');
                const labelElement = document.getElementById('carousel-label');
                const placeholder = document.getElementById('no-art-placeholder');

                function updateDisplay() {
                    if (gallery.length > 0) {
                        imgElement.style.display = 'block';
                        placeholder.style.display = 'none';
                        const item = gallery[currentIndex];
                        imgElement.src = item.src;
                        labelElement.innerText = item.label + ` (${currentIndex + 1}/${gallery.length})`;
                    } else {
                        imgElement.style.display = 'none';
                        placeholder.style.display = 'block';
                        labelElement.innerText = "NO DATA";
                    }
                }

                function nextImage() {
                    if (gallery.length === 0) return;
                    currentIndex++;
                    if (currentIndex >= gallery.length) currentIndex = 0;
                    updateDisplay();
                }

                function prevImage() {
                    if (gallery.length === 0) return;
                    currentIndex--;
                    if (currentIndex < 0) currentIndex = gallery.length - 1;
                    updateDisplay();
                }
                updateDisplay();
            </script>

            <table style="width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.9rem;">
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Developer</td>
                    <td style="padding: 10px; text-align: right;">{{ game.developer|default:"-" }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Publisher</td>
                    <td style="padding: 10px; text-align: right;">{{ game.publisher|default:"-" }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Released</td>
                    <td style="padding: 10px; text-align: right;">{{ game.release_date|date:"F j, Y"|default:"-" }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Platform</td>
                    <td style="padding: 10px; text-align: right;">{{ game.platform.name }}</td>
                </tr>
                <tr style="border-bottom: 1px solid #333;">
                    <td style="padding: 10px; color: #888;">Region</td>
                    <td style="padding: 10px; text-align: right;">
                        {% for reg in game.regions.all %}
                            {{ reg.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            -
                        {% endfor %}
                    </td>
                </tr>

                <tr style="border-bottom: 1px solid #333;">
                    <td colspan="2" style="padding: 10px;">
                        <div style="display: flex; gap: 5px; justify-content: center; font-size: 0.8rem;">
                            <span style="color: {% if game.own_game %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">
                                GAME
                            </span>
                            <span style="color: {% if game.own_box %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">
                                BOX
                            </span>
                            <span style="color: {% if game.own_manual %}var(--primary){% else %}#444{% endif %}; border: 1px solid #444; padding: 2px 5px;">
                                MAN
                            </span>
                        </div>

                        {% if game.components.exists %}
                            <div style="margin-top: 10px; text-align: center; font-size: 0.7rem; color: #888;">
                                {% for comp in game.components.all %}
                                    <div>
                                        {% if comp.is_owned %}‚úÖ{% else %}‚ùå{% endif %} {{ comp.name }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>

        <div style="flex: 2; min-width: 300px;">

            <h1 style="margin-top: 0; font-size: 2rem;">{{ game.title }}</h1>
            <div style="margin-bottom: 20px;">
                {% for genre in game.genres.all %}
                    <span style="background: var(--primary); color: #000; padding: 2px 8px; font-size: 0.7rem; font-weight: bold; margin-right: 5px;">{{ genre.name }}</span>
                {% endfor %}
            </div>

            <div style="font-size: 1rem; color: #888; margin-bottom: 30px; font-style: italic;">
                {{ game.description|linebreaks }}
            </div>

            <hr style="border: 0; border-top: 1px dashed #333; margin: 30px 0;">

            <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 40px;">

                <div style="flex: 1; min-width: 300px;">
                    <h3 class="retro-font" style="font-size: 0.8rem; margin-bottom: 10px;">Review Video</h3>
                    {% if game.video_review %}
                        <div class="video-wrapper">
                            {% video game.video_review '100% x 100%' %}
                        </div>
                    {% else %}
                        <div style="width: 100%; padding-bottom: 56.25%; background: #000; border: 1px solid #333; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="font-size: 2rem; opacity: 0.3;">üì∫</div>
                                <div style="color: #444; font-size: 0.8rem; margin-top: 10px; font-family: monospace;">NO SIGNAL</div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <div style="flex: 1; min-width: 300px;">
                    <h3 class="retro-font" style="font-size: 0.8rem; margin-bottom: 10px;">Playthrough</h3>
                    {% if game.video_playthrough %}
                        <div class="video-wrapper">
                            {% video game.video_playthrough '100% x 100%' %}
                        </div>
                    {% else %}
                        <div style="width: 100%; padding-bottom: 56.25%; background: #000; border: 1px solid #333; position: relative;">
                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                <div style="font-size: 2rem; opacity: 0.3;">üéÆ</div>
                                <div style="color: #444; font-size: 0.8rem; margin-top: 10px; font-family: monospace;">NOT PLAYED YET</div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <h2 class="retro-font" style="font-size: 1.2rem; color: var(--secondary);">480p Review</h2>
            {% if game.written_review %}
                <div style="font-size: 1.1rem; line-height: 1.8; color: #fff;">
                    {{ game.written_review|linebreaks }}
                </div>
            {% else %}
                <div style="border: 2px dashed #333; padding: 20px; background: rgba(0,0,0,0.3); text-align: center;">
                    <p style="color: #666; font-family: monospace; margin: 0;">
                        [ DATA MISSING ]<br>
                        This title has not been reviewed yet.
                    </p>
                </div>
            {% endif %}

            {% if game.extra_videos.exists %}
                <div style="margin-top: 50px; border-top: 4px solid var(--primary); padding-top: 20px;">
                    <h2 class="retro-font" style="font-size: 1.2rem; color: var(--primary);">
                        Bonus Tapes
                    </h2>
                    <div class="grid" style="gap: 20px;">
                        {% for extra in game.extra_videos.all %}
                            {% if not extra.is_patron_only or user.profile.is_patron %}
                                <div style="background: #000; border: 1px solid #333; padding: 10px;">
                                    <h4 style="margin: 0 0 10px 0; color: #fff; font-size: 0.9rem;">
                                        {% if extra.is_patron_only %}
                                            <span style="color: var(--primary);">[LOCKED]</span>
                                        {% endif %}
                                        {{ extra.title }}
                                    </h4>
                                    <div class="video-wrapper">
                                        {% video extra.url '100% x 100%' %}
                                    </div>
                                </div>
                            {% else %}
                                <div style="background: #111; border: 1px dashed #444; padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                    <div style="font-size: 2rem;">üîí</div>
                                    <div style="color: #666; margin-top: 10px;">{{ extra.title }}</div>
                                    <div style="color: var(--primary); font-size: 0.7rem; margin-top: 5px;">PATRONS ONLY</div>
                                    <a href="https://patreon.com" target="_blank" style="margin-top: 10px; color: #fff; text-decoration: underline; font-size: 0.8rem;">Unlock This</a>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

        </div>
    </div>
</div>
{% endblock %}